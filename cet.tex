%%% vim:ai:tw=72:
\chapter{Intel CET Extension}

Intel CET (Control-flow Enforcement Technology) Extension includes:

\begin{description}
  \item[IBT (Indirect Branch Tracking)] Branch protection to defend
    against Jump/Call Oriented Programming.
  \item [SHSTK (Shadow Stack)] Return address protection to defend
    against Return Oriented Programming,
\end{description}

\section{Program Loading}

\subsection{Process \code{GNU_PROPERTY_X86_FEATURE_1_IBT}}
\label{ibt}

On an IBT capable processor, the following steps should be taken:

\begin{enumerate}
  \item
    \begin{sloppypar}
      When loading an executable without interpreter, enable IBT if
      \code{GNU_PROPERTY_X86_FEATURE_1_IBT} is set on the executable.
    \end{sloppypar}
  \item
    \begin{sloppypar}
      When loading an executable with an interpreter, enable IBT if
      \code{GNU_PROPERTY_X86_FEATURE_1_IBT} is set on the interpreter.
      The interpreter should disable IBT if
      \code{GNU_PROPERTY_X86_FEATURE_1_IBT} isn't set on the executable.
    \end{sloppypar}
  \item
    \begin{sloppypar}
      After IBT is enabled, when loading a shared object without
      \code{GNU_PROPERTY_X86_FEATURE_1_IBT}:
   \end{sloppypar}
   \begin{enumerate}
    \item If legacy interwork is allowed, then mark all pages in
      executable \texttt{PT_LOAD} segments in legacy code page bitmap.
      Failure of legacy code page bitmap allocation causes an error.
    \item If legacy interwork isn't allowed, it causes an error.
   \end{enumerate}
\end{enumerate}

\subsection{Process \code{GNU_PROPERTY_X86_FEATURE_1_SHSTK}}
\label{shstk}

On a SHSTK capable processor, the following steps should be taken:

\begin{enumerate}
  \item
    \begin{sloppypar}
      When loading an executable without interpreter, enable SHSTK if
      \code{GNU_PROPERTY_X86_FEATURE_1_SHSTK} is set on the executable.
    \end{sloppypar}
  \item
    \begin{sloppypar}
      When loading an executable with an interpreter, enable SHSTK if
      \code{GNU_PROPERTY_X86_FEATURE_1_SHSTK} is set on the interpreter.
      The interpreter should disable SHSTK if
      \code{GNU_PROPERTY_X86_FEATURE_1_SHSTK} isn't set or any shared
      objects loaded via the \code{DT_NEEDED} tag.
    \end{sloppypar}
  \item
    \begin{sloppypar}
      After SHSTK is enabled, when loading a shared object without
      \code{GNU_PROPERTY_X86_FEATURE_1_SHSTK}:
    \end{sloppypar}
    \begin{enumerate}
      \item If legacy interwork is allowed, SHSTK should be disabled.
      \item If legacy interwork isn't allowed, it causes an error.
    \end{enumerate}
\end{enumerate}

\section{Dynamic Linking}

To support IBT, linker should generate a IBT-enabled PLT (Procedure
Linkage Table) (see figure \ref{ibt_plt}) together with a second
PLT (see figure \ref{ibt_sec_plt}).

\begin{figure}[H]
\Hrule
\caption{The IBT-enabled PLT}
\label{ibt_plt}
\begin{footnotesize}
\begin{verbatim}
  .PLT0: pushq    4(%ebx)                 # GOT[1]
         jmp      *8(%ebx)                # GOT[2]
         nopl     0x0(%eax)
  .PLT1: endbr32                          # 16 bytes from .PLT0
         pushq    $index1
         jmp      PLT0
         xchg     %ax,%ax
  .PLT2: endbr32                          # 16 bytes from .PLT1
         pushq    $index2
         jmp      .PLT0
         xchg     %ax,%ax
  .PLT3: ...
\end{verbatim}%$
\end{footnotesize}
\Hrule
\end{figure}

\begin{figure}[H]
\Hrule
\caption{The Second IBT-enabled PLT}
\label{ibt_sec_plt}
\begin{footnotesize}
\begin{verbatim}
  .SPLT1: endbr32
          jmp  *name1@GOT(%ebx)
          nopl 0x0(%eax,%eax,1)
  .SPLT2: endbr32
          jmp  *name2@GOT(%ebx)           # 16 bytes from .SPLT1
          nopl 0x0(%eax,%eax,1)
  .SPLT3: ...                             # 16 bytes from .SPLT2
\end{verbatim}%$
\end{footnotesize}
\Hrule
\end{figure}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: "abi"
%%% End:
